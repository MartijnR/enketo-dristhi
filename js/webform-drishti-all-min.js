/*! enketo-php-wrapper 2013-09-11 */
function GUI(){"use strict";this.supportLink='<a href="mailto:'+settings.supportEmail+'">'+settings.supportEmail+"</a>"}function Print(){"use strict";this.setStyleSheet(),this.setDpi()}function Profiler(a){var b=(new Date).getTime();this.report=function(c){c=c||"time taken for "+a+" to execute in milliseconds: "+((new Date).getTime()-b),profilerRecords.push(c)}}function divideIntoBatches(a,b){var c,d,e,f,g=[],h=[];for(c=0;c<a.length;c++)g.push({index:c,size:a[c]});for(;g.length>0;){if(e=[g[0].index],f=g[0].size,g[0].size<b)for(c=1;c<g.length;c++)f+g[c].size<b&&(e.push(g[c].index),f+=g[c].size);for(h.push(e),c=0;c<g.length;c++)for(d=0;d<e.length;d++)g[c].index===e[d]&&g.splice(c,1)}return h}function Helper(){"use strict";this.setSettings=function(){var a,b,c=[{q:"return",s:"returnURL"},{q:"showbranch",s:"showBranch"},{q:"debug",s:"debug"},{q:"touch",s:"touch"},{q:"server",s:"serverURL"},{q:"form",s:"formURL"},{q:"id",s:"formId"},{q:"formName",s:"formId"},{q:"instanceId",s:"instanceId"},{q:"entityId",s:"entityId"}];for(a=0;a<c.length;a++)b=this.getQueryParam(c[a].q),settings[c[a].s]=null!==b?b:"undefined"!=typeof settings[c[a].s]?settings[c[a].s]:null},this.getQueryParam=function(a){var b=this.getAllQueryParams();for(var c in b)if(c.toLowerCase()===a.toLowerCase())return b[c];return null},this.getAllQueryParams=function(){for(var a,b,c=window.location.search.substring(1),d=c.split("&"),e={},f=0;f<d.length;f++){var g=d[f].split("=");g[0].length>0&&(a=decodeURIComponent(g[1]),b="true"===a?!0:"false"===a?!1:a,e[g[0]]=b)}return e}}function Form(a,b,c){"use strict";function d(a){function b(a,b,e){var f="*";if(this.originalSelector=a,this.selector="string"==typeof a&&a.length>0?a:f,e="undefined"!=typeof e&&null!==e?e:{},this.filter=e,this.filter.noTemplate="undefined"!=typeof e.noTemplate?e.noTemplate:!0,this.filter.onlyLeaf="undefined"!=typeof e.onlyLeaf?e.onlyLeaf:!1,this.filter.onlyTemplate="undefined"!=typeof e.onlyTemplate?e.onlyTemplate:!1,this.filter.noEmpty="undefined"!=typeof e.noEmpty?e.noEmpty:!1,this.index=b,c.find("model>instance").length>0){if(this.selector!==f&&0!==this.selector.indexOf("/")&&d.instanceSelectRegEx.test(this.selector))return this.selector=this.selector.replace(d.instanceSelectRegEx,"model > instance#$1"),void 0;this.selector="model > instance:eq(0) "+this.selector}}var c,d=this;this.instanceSelectRegEx=/instance\([\'|\"]([^\/:\s]+)[\'|\"]\)/g,a=a.replace(/xmlns\=\"[a-zA-Z0-9\:\/\.]*\"/g,""),this.xml=$.parseXML(a),c=$(this.xml),this.$=c,XPathJS.bindDomLevel3XPath(),this.node=function(a,c,d){return new b(a,c,d)},b.prototype.get=function(){var a,b;return a=this.filter.onlyTemplate===!0?c.xfind(this.selector).filter("[template]"):this.filter.noTemplate===!0?c.xfind(this.selector).not("[template], [template] *"):c.xfind(this.selector),this.filter.noEmpty===!0?a=a.filter(function(){return b=$(this).text(),0===$(this).children().length&&$.trim(b).length>0}):this.filter.onlyLeaf===!0&&(a=a.filter(function(){return 0===$(this).children().length})),a="undefined"!=typeof this.index&&null!==this.index?a.eq(this.index):a},b.prototype.setVal=function(a,b,c){var d,e,f,g;return e=this.getVal()[0],f="undefined"!=typeof a&&null!==a?$.isArray(a)?a.join(" "):a.toString():"",f=this.convert(f,c),d=this.get(),1===d.length&&$.trim(f.toString())!==$.trim(e.toString())?(d.text(f),g=this.validate(b,c),i.trigger("dataupdate",d.prop("nodeName")),"binary"===c&&(f.length>0?d.attr("type","file"):d.removeAttr("type")),g):d.length>1?(console.error("nodeset.setVal expected nodeset with one node, but received multiple"),null):0===d.length?(console.error("Data node: "+this.selector+" with null-based index: "+this.index+" not found!"),null):null},b.prototype.getVal=function(){var a=[];return this.get().each(function(){a.push($(this).text())}),a},b.prototype.clone=function(a){var b,c;b=this.get(),a=a||b,1===b.length&&1===a.length?(b.clone().insertAfter(a).find("*").addBack().removeAttr("template"),c=[b.prop("nodeName")],b.find("*").each(function(){c.push($(this).prop("nodeName"))}),i.trigger("dataupdate",c.join(","))):console.error("node.clone() function did not receive origin and target nodes")},b.prototype.remove=function(){var a=this.get();a.length>0?(a.remove(),i.trigger("dataupdate",a.prop("nodeName"))):console.error("could not find node "+this.selector+" with index "+this.index+" to remove ")},b.prototype.convert=function(a,b){return""===a.toString()?a:"undefined"!=typeof b&&null!==b&&"undefined"!=typeof this.types[b.toLowerCase()]&&"undefined"!=typeof this.types[b.toLowerCase()].convert?this.types[b.toLowerCase()].convert(a):a},b.prototype.validate=function(a,b){var c,e,f=this.getVal()[0];return""===f.toString()?!0:(("undefined"==typeof b||null===b||"undefined"==typeof this.types[b.toLowerCase()])&&(b="string"),c=this.types[b.toLowerCase()].validate(f),e="undefined"!=typeof a&&null!==a&&a.length>0?d.evaluate(a,"boolean",this.originalSelector,this.index):!0,c&&e)},b.prototype.types={string:{validate:function(){return!0}},select:{validate:function(){return!0}},select1:{validate:function(){return!0}},decimal:{validate:function(a){return isNaN(a-0)||null===a?!1:!0}},"int":{validate:function(a){return isNaN(a-0)||null===a||Math.round(a)!=a?!1:!0}},date:{validate:function(a){var b=/([0-9]{4})([\-]|[\/])([0-9]{2})([\-]|[\/])([0-9]{2})/,c=b.exec(a);return c&&6===c.length?"Invalid Date"!==new Date(Number(c[1]),Number(c[3])-1,Number(c[5])).toString():!1},convert:function(a){var b=/([0-9]{4})([\-]|[\/])([0-9]{2})([\-]|[\/])([0-9]{2})/,c=b.exec(a),d=new Date(a);return"Invalid Date"==new Date(a).toString()&&c&&Number(c[1])>0&&Number(c[3])>=0&&Number(c[3])<12&&Number(c[5])<32&&(d=new Date(Number(c[1]),Number(c[3])-1,Number(c[5]))),d.getUTCFullYear().toString().pad(4)+"-"+(d.getUTCMonth()+1).toString().pad(2)+"-"+d.getUTCDate().toString().pad(2)}},datetime:{validate:function(a){return console.debug("datetime validation function received: "+a+" type:"+typeof a),"Invalid Date"!==new Date(a.toString()).toString()||"Invalid Date"!==new Date(this.convert(a.toString())).toString()},convert:function(a){var b,c=/([0-9]{4}\-[0-9]{2}\-[0-9]{2})([T]|[\s])([0-9]){2}:([0-9]){2}([0-9:.]*)(\+|\-)([0-9]{2}):([0-9]{2})$/,d=/([0-9]{4}\-[0-9]{2}\-[0-9]{2})([T]|[\s])([0-9]){2}:([0-9]){2}([0-9:.]*)(\+|\-)([0-9]{2})$/;return"Invalid Date"!==new Date(a).toString()&&c.test(a)?a:"Invalid Date"==new Date(a).toString()&&d.test(a)?a+":00":(b=new Date(a),"Invalid Date"!==b.toString()?b.toISOLocalString():b.toString())}},time:{validate:function(a){var b=new Date,c=a.toString().split(":");return c.length<2?!1:(c[2]=c[2]?Number(c[2].toString().split(".")[0]):0,c[0]<24&&c[0]>=0&&c[1]<60&&c[1]>=0&&c[2]<60&&c[2]>=0&&"Invalid Date"!==b.toString())},convert:function(a){var b=a.toString().split(":");return $.each(b,function(a,c){b[a]=c.toString().pad(2)}),b.join(":")}},barcode:{validate:function(){return!0}},geopoint:{validate:function(a){var b=a.toString().split(" ");return""!==b[0]&&b[0]>=-90&&b[0]<=90&&""!==b[1]&&b[1]>=-180&&b[1]<=180&&("undefined"==typeof b[2]||!isNaN(b[2]))&&("undefined"==typeof b[3]||!isNaN(b[3])&&b[3]>=0)},convert:function(a){return $.trim(a.toString())}},binary:{validate:function(){return!0}}}}function e(a){i=$(a),this.$=i,this.branch=new this.Branch(this)}var f,g,h,i,j,k,l=[];this.ex=function(a,b,c,d){return f.evaluate(a,b,c,d)},this.sfv=function(){return h.setAllVals()},this.Data=function(a){return new d(a)},this.getDataO=function(){return f},this.getDataEditO=function(){return g.get()},this.getInstanceID=function(){return f.getInstanceID()},this.Form=function(a){return new e(a)},this.getFormO=function(){return h},this.init=function(){return j=$(a).clone().appendTo("<original></original>"),f=new d(b),h=new e(a),f.init(),"undefined"!=typeof c&&c&&c.length>0&&(g=new d(c),g.init(),f.load(g)),k=$(a).find(".jr-repeat").length>0,h.init(),l.length>0&&console.error("loadErrors: ",l),l},this.getDataStr=function(a,b,c){return f.getStr(a,b,c)},this.getRecordName=function(){return h.recordName.get()},this.setRecordName=function(a){return h.recordName.set(a)},this.getRecordStatus=function(){return h.recordStatus.get()},this.setRecordStatus=function(a){return h.recordStatus.set(a)},this.setEditStatus=function(a){return h.editStatus.set(a)},this.getEditStatus=function(){return h.editStatus.get()},this.getName=function(){return i.find("#form-title").text()},this.resetHTML=function(){$("#form-languages").remove(),i.replaceWith(j)},this.validateForm=function(){return h.validateAll()},this.isValid=function(){return h.isValid()},d.prototype.init=function(){var a;this.node(null,null,{noEmpty:!0,noTemplate:!1}).get().each(function(){a=$(this).text(),$(this).text($.trim(a))}),this.cloneAllTemplates()},d.prototype.getInstanceID=function(){return this.node(":first>meta>instanceID").getVal()[0]},d.prototype.load=function(a){var b,c,d,e,f,g,j,k,m,n,o,p=this,q={noTemplate:!0,noEmpty:!0};if(b=a.node(null,null,q).get(),console.debug("nodes to load: ",b),this.node(null,null,q).get().each(function(){$(this).text("")}),b.each(function(){var b=$(this).prop("nodeName");e=h.generateName($(this)),c=a.node(e).get().index($(this)),f=$(this).text(),j=i.find('[name="'+e+'"]').eq(0),d=j.length>0?h.input.getXmlType(j):"string",g=p.node(e,c),k=g.get(),k.length>1?console.error("Found multiple nodes with path: "+e+" and index: "+c):1===k.length?g.setVal(f,null,d):p.node(e,c,{noTemplate:!1}).get().length>0?(m=p.node(e,0,{noTemplate:!1}).get().closest("[template]"),p.cloneTemplate(h.generateName(m),c-1),g=p.node(e,c),1===g.get().length?g.setVal(f,null,d):(o="Error occured trying to clone template node to set the repeat value of the instance to be edited.",console.error(o),l.push(o))):1===$(this).parent("meta").length&&1===p.node(h.generateName($(this).parent("meta")),0).get().length?0===p.node(":first > meta > "+b,0).get().length?(console.debug("cloning this direct child of <meta>"),$(this).clone().appendTo(p.node(":first > meta").get())):(o="Found duplicate meta node ("+b+")!",console.error(o),l.push(o)):(o="Did not find form node with path: "+e+" and index: "+c+" so failed to load data.",console.error(o),l.push(o))}),n=this.node("*>meta>instanceID"),1!==n.get().length)return o="InstanceID node in default instance error (found "+n.get().length+" instanceID nodes)",console.error(o),l.push(o),void 0;if(1!==this.node("*>meta>deprecatedID").get().length){var r=$.parseXML("<deprecatedID/>").documentElement;$(r).appendTo(this.node("*>meta").get())}this.node("*>meta>deprecatedID").setVal(n.getVal()[0],null,"string"),n.setVal("",null,"string")},d.prototype.cloneTemplate=function(a,b){var c,d,e=this.node(a,0,{onlyTemplate:!0});e=0===e.get().length?this.node(a,0):e,d=e.get().prop("nodeName"),c=this.node(a,b).get(),1===e.get().length&&1===c.length&&c.next().prop("nodeName")!==d?e.clone(c):c.next().prop("nodeName")!==d&&console.error("Could not find template node and/or node to insert the clone after")},d.prototype.cloneAllTemplates=function(a){var b=this;("undefined"==typeof a||0===a.length)&&(a=this.$.find(":first")),a.children("[template]").each(function(){"undefined"==typeof $(this).parent().attr("template")&&0===$(this).siblings($(this).prop("nodeName")).not("[template]").length&&$(this).clone().insertAfter($(this)).find("*").addBack().removeAttr("template")}),a.children().not("[template]").each(function(){b.cloneAllTemplates($(this))})},d.prototype.get=function(){return this.$||null},d.prototype.getXML=function(){return this.xml||null},d.prototype.getStr=function(a,b,c){var d;return d=(new XMLSerializer).serializeToString(this.getInstanceClone(a,b,c)[0]),d=d.replace(/\t/g,"")},d.prototype.getInstanceClone=function(a,b,c){var d=c?this.$.find(":first").clone():this.node("> *:first").get().clone();return a?d:d.find("[template]").remove().end()},d.prototype.makeBugCompliant=function(a,b,c){var d,e,f,g,i,j,k,l;for(g=this.node(b,c).get(),l=g.parents().add(g),d=l.length-1;d>=0;d--)i=l.eq(d),j=i.prop("nodeName"),k=i.siblings(j+":not([template])"),"instance"!==j.toLowerCase()&&"model"!==j.toLowerCase()&&k.length>0&&(e=h.generateName(i),f=k.add(i).index(i),a=a.replace(new RegExp(e,"g"),e+"["+(f+1)+"]"));return a},d.prototype.evaluate=function(a,b,c,e){var f,g,h,i,j,k,m,n,o,p,q,r;if(console.debug("evaluating expr: "+a+" with context selector: "+c+", 0-based index: "+e+" and result type: "+b),b=b||"any",e=e||0,a=a.trim(),j=new d(this.getStr(!1,!1)),this.instanceSelectRegEx.test(a))for(k=a.match(this.instanceSelectRegEx),f=0;f<k.length;f++)m=k[f].match(/[\'|\"]([^\'']+)[\'|\"]/)[1],a=a.replace(k[f],'/node()/instance[@id="'+m+'"]'),this.$.find(":first>instance#"+m).clone().appendTo(j.$.find(":first"));"undefined"!=typeof c&&null!==c?(i=j.$.xfind(c).eq(e)[0],r=this.node(c).get(),r.length>1&&(a=this.makeBugCompliant(a,c,e))):i=j.getXML(),o={0:["any","ANY_TYPE"],1:["number","NUMBER_TYPE","numberValue"],2:["string","STRING_TYPE","stringValue"],3:["boolean","BOOLEAN_TYPE","booleanValue"],7:["nodes","ORDERED_NODE_SNAPSHOT_TYPE"],9:["node","FIRST_ORDERED_NODE_TYPE"]};for(n in o){if(n=Number(n),o[n][0]==b)break;n=0}a=a.replace(/&lt;/g,"<"),a=a.replace(/&gt;/g,">"),a=a.replace(/&quot;/g,'"');try{if(p=document.evaluate(a,i,null,n,null),0===n){for(n in o)if(n=Number(n),n==Number(p.resultType))return p=n>0&&4>n?p[o[n][2]]:p,console.debug("evaluated "+a+" to: ",p),p;console.error("Expression: "+a+" did not return any boolean, string or number value as expected")}else if(7===n){for(q=$(),g=0;g<p.snapshotLength;g++)q=q.add(p.snapshotItem(g));return q}return console.debug("evaluated "+a+" to: "+p[o[n][2]]),p[o[n][2]]}catch(s){return h="Error occurred trying to evaluate: "+a+", message: "+s.message,console.error(h),$(document).trigger("xpatherror",h),l.push(h),null}},e.prototype.init=function(){var a,b;return"undefined"!=typeof f&&f instanceof d?(this.preloads.init(this),this.grosslyViolateStandardComplianceByIgnoringCertainCalcs(),this.calcUpdate(),Modernizr.touch||(b='<span class="hint" ><i class="icon-question-sign"></i></span>',i.find(".jr-hint ~ input, .jr-hint ~ select, .jr-hint ~ textarea").before(b),i.find("legend > .jr-hint").parent().find("span:last-child").after(b),i.find(".trigger > .jr-hint").parent().find("span:last").after(b)),i.find("select, input, textarea").not('[type="checkbox"], [type="radio"], [readonly], #form-languages').before($("<br/>")),i.find('input[type="radio"]').each(function(){a=$(this).attr("name"),$(this).attr("data-name",a)}),this.langs.init(),this.repeat.init(this),this.itemsetUpdate(),this.setAllVals(),this.widgets.init(),this.bootstrapify(),this.branch.init(),this.outputUpdate(),this.setHints(),this.setEventHandlers(),this.editStatus.set(!1),void 0):console.error("variable data needs to be defined as instance of DataXML")},e.prototype.checkForErrors=function(){var a,b=[],c={},d=i.find("#stats");if(d.length>0)for(c.jrItem=parseInt(d.find('[id="jrItem"]').text(),10),c.jrInput=parseInt(d.find('[id="jrInput"]').text(),10),c.jrItemset=parseInt(d.find('[id="jrItemset"]').text(),10),c.jrUpload=parseInt(d.find('[id="jrUpload"]').text(),10),c.jrTrigger=parseInt(d.find('[id="jrTrigger"]').text(),10),c.jrConstraint=parseInt(d.find('[id="jrConstraint"]').text(),10),c.jrRelevant=parseInt(d.find('[id="jrRelevant"]').text(),10),c.jrCalculate=parseInt(d.find('[id="jrCalculate"]').text(),10),c.jrPreload=parseInt(d.find('[id="jrPreload"]').text(),10),c.hRadio=i.find('input[type="radio"]').length,c.hCheck=i.find('input[type="checkbox"]').length,c.hSelect=i.find("select:not(#form-languages)").length,c.hItemset=i.find(".itemset-template").length,c.hOption=i.find('select:not(#form-languages) > option[value!=""]').length,c.hInputNotRadioCheck=i.find('textarea, input:not([type="radio"],[type="checkbox"])').length,c.hTrigger=i.find(".trigger").length,c.hRelevantNotRadioCheck=i.find('[data-relevant]:not([type="radio"],[type="checkbox"])').length,c.hRelevantRadioCheck=i.find('input[data-relevant][type="radio"],input[data-relevant][type="checkbox"]').parent().parent("fieldset").length,c.hConstraintNotRadioCheck=i.find('[data-constraint]:not([type="radio"],[type="checkbox"])').length,c.hConstraintRadioCheck=i.find('input[data-constraint][type="radio"],input[data-constraint][type="checkbox"]').parent().parent("fieldset").length,c.hCalculate=i.find("[data-calculate]").length,c.hPreload=i.find("#jr-preload-items input").length,0===c.jrItemset&&c.jrItem!==c.hOption+c.hRadio+c.hCheck&&console.error(" total number of option fields differs between XML form and HTML form"),c.jrItemset!==c.hItemset&&console.error(" total number of itemset fields differs between XML form ("+c.jrItemset+") and HTML form ("+c.hItemset+")"),c.jrInput+c.jrUpload!==c.hInputNotRadioCheck-c.hCalculate-c.hPreload&&console.error(" total number of input/upload fields differs between XML form and HTML form"),c.jrTrigger!=c.hTrigger&&console.error(" total number of triggers differs between XML form and HTML form"),c.jrRelevant!=c.hRelevantNotRadioCheck+c.hRelevantRadioCheck&&console.error(" total number of branches differs between XML form and HTML form (not a problem if caused by obsolete bindings in xml form)"),c.jrConstraint!=c.hConstraintNotRadioCheck+c.hConstraintRadioCheck&&console.error(" total number of constraints differs between XML form ("+c.jrConstraint+") and HTML form ("+(c.hConstraintNotRadioCheck+c.hConstraintRadioCheck)+")(not a problem if caused by obsolete bindings in xml form)."+" Note that constraints on &lt;trigger&gt; elements are ignored in the transformation and could cause this error too."),c.jrCalculate!=c.hCalculate&&console.error(" total number of calculated items differs between XML form and HTML form"),c.jrPreload!=c.hPreload&&console.error(" total number of preload items differs between XML form and HTML form"),i.find("[name]").each(function(){$.inArray($(this).attr("name"),b)&&b.push($(this).attr("name"))}),a=0;a<b.length;a++)f.node(b[a]).get().length<1&&console.error("Found name attribute: "+b[a]+" that does not have a corresponding data node. Transformation error or XML form error (relative nodesets perhaps?")},e.prototype.input={getWrapNodes:function(a){var b=this.getInputType(a.eq(0));return"radio"==b||"checkbox"==b?a.closest(".restoring-sanity-to-legends"):"fieldset"==b?a:a.parent("label")},getProps:function(a){return 1!==a.length?console.error("getProps(): no input node provided or multiple"):{path:this.getName(a),ind:this.getIndex(a),inputType:this.getInputType(a),xmlType:this.getXmlType(a),constraint:a.attr("data-constraint"),relevant:a.attr("data-relevant"),val:this.getVal(a),required:void 0!==a.attr("required")&&0===a.parents(".jr-appearance-label").length?!0:!1,enabled:this.isEnabled(a),multiple:this.isMultiple(a)}},getInputType:function(a){var b;return 1!==a.length?"":(b=a.prop("nodeName").toLowerCase(),"input"==b?a.attr("type").length>0?a.attr("type").toLowerCase():console.error("<input> node has no type"):"select"==b?"select":"textarea"==b?"textarea":"fieldset"==b?"fieldset":console.error("unexpected input node type provided"))},getXmlType:function(a){return 1!==a.length?console.error("getXMLType(): no input node provided or multiple"):a.attr("data-type-xml")},getName:function(a){var b;return 1!==a.length?console.error("getName(): no input node provided or multiple"):(b=a.attr("data-name")||a.attr("name"),b||console.error("input node has no name"))},getIndex:function(a){var b,c,d,e;return 1!==a.length?console.error("getIndex(): no input node provided or multiple"):(b=this.getInputType(a),c=this.getName(a),d=this.getWrapNodes(a),e="radio"===b&&c!==a.attr("name")?this.getWrapNodes(i.find('[data-name="'+c+'"]')):"fieldset"===b&&a.hasClass("jr-repeat")?this.getWrapNodes(i.find('.jr-repeat[name="'+c+'"]')):"fieldset"===b&&a.hasClass("jr-group")?this.getWrapNodes(i.find('.jr-group[name="'+c+'"]')):this.getWrapNodes(i.find('[name="'+c+'"]')),e.index(d))},isMultiple:function(a){return"checkbox"==this.getInputType(a)||void 0!==a.attr("multiple")?!0:!1},isEnabled:function(a){return!(a.prop("disabled")||a.parents("fieldset:disabled").length>0)},getVal:function(a){var b,c,d=[];return 1!==a.length?console.error("getVal(): no inputNode provided or multiple"):(b=this.getInputType(a),c=this.getName(a),"radio"==b?this.getWrapNodes(a).find("input:checked").val()||"":"checkbox"==b?(this.getWrapNodes(a).find('input[name="'+c+'"]:checked').each(function(){d.push($(this).val())}),d):a.val()?$.isArray(a.val())?a.val().join(" ").trim():a.val().trim():"")},setVal:function(a,b,c){var d,e,g;return b=b||0,"radio"==this.getInputType(i.find('[data-name="'+a+'"]').eq(0))?(g=this.getWrapNodes(i.find('[data-name="'+a+'"]')).eq(b).find('input[value="'+c+'"]'),g.prop("checked",!0),void 0):(d=this.getWrapNodes(i.find('[name="'+a+'"]')).eq(b).find("input, select, textarea"),e=this.getInputType(d.eq(0)),"file"===e?(d.eq(0).attr("data-loaded-file-name",c),!1):(("date"===e||"datetime"===e)&&(c=f.node().convert(c,e),console.debug("converting date before setting input field to: "+c)),this.isMultiple(d.eq(0))===!0&&(c=c.split(" ")),d.val(c),void 0))}},e.prototype.setAllVals=function(){var a,b,c,d=this;f.node(null,null,{noEmpty:!0}).get().each(function(){try{c=$(this).text(),b=d.generateName($(this)),a=f.node(b).get().index($(this)),console.debug("calling input.setVal with name: "+b+", index: "+a+", value: "+c),d.input.setVal(b,a,c)}catch(e){l.push("Could not load input field value with name: "+b+" and value: "+c)}})},e.prototype.langs={init:function(){var a,b=this,c=i.find("#form-languages").attr("data-default-lang"),d=$(".form-language-selector");return $("#form-languages").detach().appendTo(d),c&&""!==c||(c=$("#form-languages option:eq(0)").attr("value")),console.debug("default language is: "+c),$("#form-languages").val(c),$("#form-languages option").length<2?(d.hide(),void 0):($("#form-languages").change(function(c){a=$(this).val(),console.debug("form-language change event detected!"),c.preventDefault(),b.setAll(a)}),void 0)},setAll:function(a){var b=this;$("#form-languages option").removeClass("active"),$(this).addClass("active"),i.find("[lang]").removeClass("active").filter('[lang="'+a+'"], [lang=""]').addClass("active"),i.find("select").each(function(){b.setSelect($(this))}),i.find("legend span.active:not(.jr-hint, .jr-constraint-msg), label span.active:not(.jr-hint, .jr-constraint-msg)").each(function(){0===$(this).text().trim().length&&$(this).text("[MISSING TRANSLATION]")}),i.trigger("changelanguage")},setSelect:function(a){var b,c,d;console.debug("setting select labels"),a.children("option").not('[value=""]').each(function(){c=$(this).text(),b=$(this).attr("value"),d=$(this).parent("select").siblings(".jr-option-translations").children('.active[data-option-value="'+b+'"]').text().trim(),d="undefined"!=typeof d&&d.length>0?d:c,$(this).text(d)})}},e.prototype.setHints=function(a){if(!Modernizr.touch){var b,c,d,e,f;f=a&&a.outputsOnly?a.outputsOnly:!1,d=f?i.find("*>.jr-hint>.jr-output").parent():i.find("*>.jr-hint"),d.parent().each(function(){e="label"!==$(this).prop("nodeName").toLowerCase()&&"fieldset"!==$(this).prop("nodeName").toLowerCase()?$(this).parent("fieldset"):$(this),c=e.find(".hint"),b=$(this).find(".jr-hint.active").text().trim(),b.length>0?c.attr("title",b):c.removeAttr("title"),c.tooltip("fixTitle").tooltip({placement:"right"})})}},e.prototype.editStatus={set:function(a){i.attr("data-edited",Boolean(a)),i.trigger("edit",a)},get:function(){return"true"===i.attr("data-edited")?!0:!1}},e.prototype.recordName={set:function(a){i.attr("data-stored-with-key",a),i.find("h2 span").text(a)},get:function(){return i.attr("data-stored-with-key")||null},reset:function(){i.removeAttr("data-stored-with-key")}},e.prototype.recordStatus={set:function(a){i.attr("data-stored-final",a.toString())},get:function(){return"true"===i.attr("data-stored-final")?!0:!1},reset:function(){i.removeAttr("data-stored-final")}},e.prototype.Branch=function(a){this.init=function(){this.update()},this.update=function(b){var c,d,e,f,g,h,j,l,m,n,o={},p=[],q=this,r=0;for(g="undefined"!=typeof b?b.split(","):[],h=g.length>0?[]:["[data-relevant]"],c=0;c<g.length;c++)h.push('[data-relevant*="'+g[c]+'"]');return n=k&&i.find(".jr-repeat.clone").length>0?!0:!1,i.find(h.join()).each(function(){if(-1===$.inArray($(this).attr("name"),p)){if(d={},m=null,d.relevant=$(this).attr("data-relevant"),d.path=a.input.getName($(this)),e=$(this).closest(".jr-branch"),1!==e.length)return 0===$(this).parents("#jr-calculated-items").length&&console.error("could not find branch node for ",$(this)),void 0;j=n&&e.closest(".jr-repeat").length>0?!0:!1,l=n&&e.closest(".jr-repeat.clone").length>0?!0:!1,d.ind=l?a.input.getIndex($(this)):0,-1===d.relevant.indexOf("..")&&(j||(m=d.relevant)),m&&"undefined"!=typeof o[m]?f=o[m]:(f=q.evaluate(d.relevant,d.path,d.ind),r++,o[m]=f),j||p.push($(this).attr("name")),q.process(e,f)}}),!0},this.evaluate=function(a,b,c){var d=f.evaluate(a,"boolean",b,c);return d},this.process=function(a,b){b===!0?(console.log("going to enable ",a),this.enable(a)):(console.log("going to disable ",a),this.disable(a))},this.selfRelevant=function(a){return!a.hasClass("disabled")&&!a.hasClass("pre-init")},this.ancestorRelevant=function(a){return 0===a.parents(".disabled").length},this.enable=function(b){var c,d=this;this.selfRelevant(b)||(console.debug("enabling branch with name: "+b.attr("name")),b.removeClass("disabled pre-init").show(250,function(){d.ancestorRelevant(b)&&a.widgets.tableWidget(b)}),c=b.prop("nodeName").toLowerCase(),"label"==c?b.children("input:not(.force-disabled), select, textarea").prop("disabled",!1):(b.prop("disabled",!1),b.find('*:not(.jr-branch) input[type="file"]:not(.force-disabled, [data-relevant])').prop("disabled",!0).prop("disabled",!1)))},this.disable=function(b){var c=b.prop("nodeName").toLowerCase(),d=b.hasClass("pre-init");(this.selfRelevant(b)||d)&&(console.debug("disabling branch"),b.addClass("disabled"),"undefined"==typeof settings||"undefined"==typeof settings.showBranch||settings.showBranch||b.hide(250),d?b.removeClass("pre-init"):(b.clearInputs("change"),b.find(".invalid-required, .invalid-constraint").find("input, select, textarea").each(function(){a.setValid($(this))})),"label"==c?b.children("input, select, textarea").prop("disabled",!0):b.prop("disabled",!0))}},e.prototype.itemsetUpdate=function(a){console.log("checking if itemsets need updating because values of following nodes changed: "+a);var b,c,d,e=this,g=[],h={};"undefined"==typeof a?g=[".itemset-template"]:$.each(a.split(","),function(a,b){g.push('.itemset-template[data-items-path*="'+b+'"]')}),g=g.join(","),b=k&&i.find(".jr-repeat.clone").length>0?!0:!1,i.find(g).each(function(){var a,g,i,j,k,l,m=$(this),n={},o=m.data(),p=$(this).prop("nodeName").toLowerCase(),q="label"===p?$(this).children("input").eq(0):$(this).parent("select"),r=m.closest("label, select").siblings(".itemset-labels"),s=m.attr("data-items-path"),t=r.attr("data-label-type"),u=r.attr("data-label-ref"),v=r.attr("data-value-ref");return l=e.input.getName(q),c=b&&q.closest(".jr-repeat").length>0?!0:!1,d=b&&q.closest(".jr-repeat.clone").length>0?!0:!1,k=d?e.input.getIndex(q):0,"undefined"!=typeof h[s]?(j=h[s],console.debug("using cached itemset items result for "+s)):(console.debug("no cache for "+s+", need to evaluate XPath"),j=f.evaluate(s,"nodes",l,k),c||(h[s]=j)),n.length=j.length,n.text=j.text(),n.length===o.length&&n.text===o.text?(console.debug("itemset unchanged"),void 0):(m.data(n),$(this).closest("label > select, fieldset > label").parent().clearInputs("change").find(p).not(m).remove(),$(this).parent("select").siblings(".jr-option-translations").empty(),j.each(function(){a=$("<root/>"),m.clone().appendTo(a).removeClass("itemset-template").addClass("itemset").removeAttr("data-items-path"),g="itext"===t?r.find('[data-itext-id="'+$(this).children(u).text()+'"]').clone():$('<span class="active" lang="">'+$(this).children(u).text()+"</span>"),i=$(this).children(v).text(),a.find("[value]").attr("value",i),"label"===p?(a.find("input").after(g),r.before(a.find(":first"))):"option"===p&&(1===g.length&&a.find("option").text(g.text()),g.attr("data-option-value",i).attr("data-itext-id","").appendTo(r.siblings(".jr-option-translations")),m.siblings().addBack().last().after(a.find(":first")))}),"select"===q.prop("nodeName").toLowerCase()&&(e.langs.setSelect(q),q.trigger("changeoption")),void 0)}),console.log("itemset update finished")},e.prototype.outputUpdate=function(a){var b,c,d,e,g,h,j,l,m,n,o=!1,p={},q="",r=this;for(d="undefined"!=typeof a?a.split(","):[],e=d.length>0?[]:[".jr-output[data-value]"],b=0;b<d.length;b++)e.push('.jr-output[data-value*="'+d[b]+'"]');g=k&&i.find(".jr-repeat.clone").length>0?!0:!1,i.find(":not(:disabled) span.active").find(e.join()).each(function(){c=$(this).attr("data-value"),l=1===$(this).parent("span").parent("label").find("[name]").eq(0).length?$(this).parent().parent().find("[name]:eq(0)"):1===$(this).parent("span").parent("legend").parent("fieldset").find("[name]").eq(0).length?$(this).parent().parent().parent().find("[name]:eq(0)"):$(this).closest("[name]"),m=r.input.getName(l),h=g&&$(this).closest(".jr-repeat").length>0,j=g&&$(this).closest(".jr-repeat.clone").length>0,n=j?r.input.getIndex(l):0,"undefined"!=typeof p[c]?q=p[c]:(q=f.evaluate(c,"string",m,n),h||(p[c]=q)),$(this).text!==q&&($(this).text(q),o=!0)}),o&&this.setHints({outputsOnly:!0})},e.prototype.grosslyViolateStandardComplianceByIgnoringCertainCalcs=function(){var a=i.find('[name$="/meta/instanceID"][data-calculate]');a.length>0&&(console.debug("Found meta/instanceID with binding that has a calculate attribute and removed this calculation. It ain't right!"),a.removeAttr("data-calculate"))},e.prototype.calcUpdate=function(a){var b,c,d,e,g,h,j,k,l,m,n,o;for(l="undefined"!=typeof a?a.split(","):[],n=l.length>0?[]:["input[data-calculate]"],b=0;b<l.length;b++)n.push('input[data-calculate*="'+l[b]+'"], input[data-relevant*="'+l[b]+'"]');i.find("#jr-calculated-items").find(n.join()).each(function(){c=$(this).attr("name"),d=$(this).attr("data-calculate"),e=$(this).attr("data-type-xml"),k=$(this).attr("data-constraint"),h=$(this).attr("data-relevant"),g=h?f.evaluate(h,"boolean",c):!0,o=f.node(c).get(),o.each(function(a){j=g?f.evaluate(d,"string",c,a):"",m=f.node(c,a).setVal(j,k,e)})})},e.prototype.bootstrapify=function(){i.addClass("clearfix").find("label, legend").each(function(){var a=$(this);0!==a.siblings("legend").length||0!==a.parent("#jr-calculated-items, #jr-preload-items").length||0!==a.find(".jr-constraint-msg").length||"legend"!=a.prop("nodeName").toLowerCase()&&a.children("input.ignore").length===a.children("input").length&&a.children("select.ignore").length===a.children("select").length&&a.children("textarea.ignore").length===a.children("textarea").length||a.prepend('<span class="jr-constraint-msg active" lang="">Value not allowed</span>')}),i.find(".trigger").addClass("alert alert-block"),i.find(".jr-constraint-msg").parent().each(function(){var a=$(this).find(".jr-constraint-msg").detach(),b=$(this).closest("label, fieldset");b.append(a),a.after('<span class="jr-required-msg active" lang="">This field is required</span>')}),Modernizr.touch||$(".form-header [title]").tooltip({placement:"bottom"})},e.prototype.widgets={init:function(a){this.repeat=a?!0:!1,this.$group=a||i,this.readonlyWidget(),this.pageBreakWidget();var b=/GT-P31[0-9]{2}.+AppleWebKit\/534\.30/;Modernizr.touch&&Modernizr.inputtypes.date&&!b.test(navigator.userAgent)||this.dateWidget(),Modernizr.touch&&Modernizr.inputtypes.time||this.timeWidget(),Modernizr.touch&&Modernizr.inputtypes.datetime||this.dateTimeWidget(),Modernizr.touch?(this.mobileSelectWidget(),this.touchRadioCheckWidget()):this.selectWidget(),this.geopointWidget(),this.tableWidget(),this.spinnerWidget(),this.sliderWidget(),this.barcodeWidget(),this.offlineFileWidget(),this.mediaLabelWidget(),this.radioEventsWidget(),this.radioCheckWidget(),this.radioUnselectWidget()},radioEventsWidget:function(){i.on("click","label",function(){console.log("click label")}),i.on("focus","label",function(){console.log("focus label")
}),i.on("click",'input[type="radio"], input[type="checkbox"]',function(){console.log("click input, checked:"+$(this).is(":checked"))}),i.on("focus",'input[type="radio"], input[type="checkbox"]',function(){console.log("focus input, checked:"+$(this).is(":checked"))}),i.on("change",'input[type="radio"], input[type="checkbox"]',function(){console.log("change input, checked:"+$(this).is(":checked"))})},radioCheckWidget:function(){if(!this.repeat){var a;i.on("click",'input[type="radio"]:checked',function(){$(this).parent("label").siblings().removeAttr("data-checked").end().attr("data-checked","true")}),i.on("click",'input[type="checkbox"]',function(){a=$(this).parent("label"),$(this).is(":checked")?a.attr("data-checked","true"):a.removeAttr("data-checked")}),i.find('input[type="radio"]:checked, input[type="checkbox"]:checked').parent("label").attr("data-checked","true")}},radioUnselectWidget:function(){this.repeat||(console.debug("initializing radio unselect widget"),i.on("click",'[data-checked]>input[type="radio"]',function(){console.debug("registered click event on label with data-checked attribute"),$(this).prop("checked",!1).trigger("change").parent().removeAttr("data-checked")}))},touchRadioCheckWidget:function(){this.repeat||i.find("fieldset:not(.jr-appearance-compact, .jr-appearance-quickcompact, .jr-appearance-label, .jr-appearance-list-nolabel )").children("label").children('input[type="radio"], input[type="checkbox"]').parent("label").addClass("btn-radiocheck")},dateWidget:function(){this.$group.find('input[type="date"]').each(function(){var a=$(this),b=$(this).parent("label"),c=b.hasClass("jr-appearance-month-year")?"year":b.hasClass("jr-appearance-year")?"decade":"month",d=(b.hasClass("jr-appearance-month-year")?"changeMonth":b.hasClass("jr-appearance-year")?"changeYear":"changeDate","year"===c?"yyyy-mm":"decade"===c?"yyyy":"yyyy-mm-dd"),e=$('<div class="widget date"><input class="ignore input-small" readonly="readonly" type="text" value="'+$(this).val()+'" placeholder="'+d+'" />'+'<button class="btn-reset"><i class="icon icon-trash"></i></button></div>'),g=e.find(".btn-reset"),h=e.find("input");a.next(".widget.date").remove(),a.hide().after(e),h.on("change",function(){console.debug("fakedate input field change detected. new value: "+$(this).val());var b=$(this).val();return b.length>0&&(b="yyyy-mm"===d?b+"-01":"yyyy"===d?b+"-01-01":b,b=f.node().convert(b,"date")),a.val()!==b&&a.val(b).trigger("change").blur(),!1}),h.on("focus blur",function(b){a.trigger(b.type)}),g.on("click",function(){h.val("").trigger("change").datepicker("update")}),h.datepicker({format:d,autoclose:!0,todayHighlight:!0,startView:c,orientation:"top"}).on("changeDate",function(){var b=$(this).val();a.val(b).trigger("change").blur()})})},timeWidget:function(){this.$group.find('input[type="time"]').each(function(){var a=$(this),b=($(this).parent("label"),$(this).val()),c=$('<div class="widget bootstrap-timepicker"><input class="ignore timepicker-default input-small" readonly="readonly" type="text" value="'+b+'" placeholder="hh:mm" />'+'<button class="btn-reset"><i class="icon icon-trash"></i></button></div>'),d=c.find(".btn-reset"),e=c.find("input");a.next(".widget.bootstrap-timepicker-component").remove(),a.hide().after(c),e.timepicker({defaultTime:b.length>0?b:"current",showMeridian:!1}).val(b),c.find("input").addClass("ignore"),e.on("change",function(){return a.val($(this).val()).trigger("change").blur(),!1}),d.on("click",function(){e.val("").trigger("change")}),e.on("focus blur",function(b){a.trigger(b.type)})})},dateTimeWidget:function(){this.$group.find('input[type="datetime"]').each(function(){function a(){if(j.val().length>0&&k.val().length>0){var a=j.val().split("-"),c=k.val().split(":");console.log("changing datetime"),b.val(new Date(a[0],a[1]-1,a[2],c[0],c[1]).toISOLocalString()).trigger("change").blur()}else b.val("").trigger("change").blur()}var b=$(this),c=$(this).val().length>0?new Date($(this).val()).toISOLocalString():"",d=c.split("T"),e=d[0],f=d[1]&&d[1].length>4?d[1].substring(0,5):"",g=$('<div class="date" ><input class="ignore input-small" type="text" readonly="readonly" value="'+e+'" placeholder="yyyy-mm-dd"/>'+"</div>"),h=$('<div class="bootstrap-timepicker"><input class="ignore timepicker-default input-small" readonly="readonly" type="text" value="'+f+'" placeholder="hh:mm"/>'+'<button class="btn-reset"><i class="icon icon-trash"></i></button></div>'),i=h.find(".btn-reset"),j=g.find("input"),k=h.find("input");b.next(".widget.datetimepicker").remove(),b.hide().after('<div class="datetimepicker widget" />'),b.siblings(".datetimepicker").append(g).append(h),j.datepicker({format:"yyyy-mm-dd",autoclose:!0,todayHighlight:!0}),k.timepicker({defaultTime:f.length>0?"value":"current",showMeridian:!1}).val(f),h.find("input").addClass("ignore"),j.on("change changeDate",function(){return a(),!1}),k.on("change",function(){return a(),!1}),j.add(k).on("focus blur",function(a){b.trigger(a.type)}),i.on("click",function(){j.val("").trigger("change").datepicker("update"),k.val("").trigger("change")})})},selectWidget:function(){this.$group.find("select").not("#form-languages").selectpicker(),this.repeat||(i.on("changelanguage",function(){i.find("select").selectpicker("update")}),i.on("changeoption","select",function(){$(this).selectpicker("update")}))},mobileSelectWidget:function(){var a=function(a){var b=$.isArray(a.val())?a.val():[a.val()],c=[];console.log("mobileSelectWidget change event detected, values selected: ",b);for(var d=0;d<b.length;d++)c.push($(this).find('option[value="'+b[d]+'"]').text());a.siblings(".widget.mobileselect").remove(),a.after('<span class="widget mobileselect">'+b.join(", ")+"</span>")};i.on("change","select[multiple]",function(){return a($(this)),!0}),i.find("select[multiple]").each(function(){a($(this))})},pageBreakWidget:function(){this.repeat||i.find(".jr-appearance-page-break input[readonly]").parent("label").each(function(){var a='name="'+$(this).find("input").attr("name")+'"';$('<hr class="manual page-break" '+a+"></hr>").insertBefore($(this)).find("input").remove(),$(this).remove()})},readonlyWidget:function(){this.repeat||i.find('input[readonly]:not([data-type-xml="geopoint"])').parent("label").each(function(){var a=$(this).find("input").attr("data-relevant"),b=a?" jr-branch pre-init":"",c='name="'+$(this).find("input").attr("name")+'"',d="undefined"!=typeof a?'data-relevant="'+a+'" '+c:c,e=$(this).find("input, select, textarea").val(),f=$(this).markdownToHtml().html();$('<fieldset class="trigger'+b+'" '+d+"></fieldset>").insertBefore($(this)).append(f).append('<div class="note-value">'+e+"</div>").find("input").remove(),$(this).remove()})},tableWidget:function(a){var b=a||i;setTimeout(function(){console.debug("setting table column widths"),b.parent().find(".jr-appearance-field-list .jr-appearance-list-nolabel, .jr-appearance-field-list .jr-appearance-label").parent().parent(".jr-appearance-field-list").each(function(){$(this).find(".jr-appearance-label label>img").parent().css("width","auto").toSmallestWidth(),$(this).find("label").css("width","auto").toLargestWidth(),$(this).find("legend").css("width","auto").toLargestWidth(35)})},50)},spinnerWidget:function(){},sliderWidget:function(){},geopointWidget:function(){this.$group.find('input[data-type-xml="geopoint"]').geopointWidget({touch:Modernizr.touch})},autoCompleteWidget:function(){},barcodeWidget:function(){},offlineFileWidget:function(){if(!this.repeat){var a="Awaiting user permission to store local data (files)",b="info",c=!1,d=i.find('input[type="file"]');if(0!==d.length){if("undefined"==typeof fileManager?(b="warning",a="File uploads not supported."):fileManager.isSupported()?c=!0:(b="warning",a="File uploads not supported by your browser"),d.prop("disabled",!0).addClass("ignore force-disabled").after('<div class="file-feedback text-'+b+'">'+a+"</div>"),!c)return d.hide(),void 0;i.on("change.passthrough",'input[type="file"]',function(a){if(fileManager.getCurrentQuota()){var b,c,d,e,f=$(this);return console.debug("namespace: "+a.namespace),"passthrough"===a.namespace?(f.trigger("change.file"),!1):(b=f.attr("data-previous-file-name"),c=f[0].files[0],d=f.attr("accept"),e=d&&"image/*"===d?$("<img />"):"audio/*"===d?$('<audio controls="controls"/>'):"video/*"===d?$('<video controls="controls"/>'):$("<span>No preview (unknown mediatype)</span>"),e.addClass("file-preview"),!b||c&&b===c.name||fileManager.deleteFile(b),f.siblings(".file-feedback, .file-preview, .file-loaded").remove(),console.debug("file: ",c),c&&c.size>0&&c.size<=connection.maxSubmissionSize()?(console.debug("going to save it in filesystem"),fileManager.saveFile(c,{success:function(a){e.attr("src",a),f.trigger("change.passthrough").after(e)},error:function(a){console.error("error: ",a),f.val(""),f.after('<div class="file-feedback text-error">Failed to save file</span>')}}),!1):(c.size>connection.maxSubmissionSize()&&f.after('<div class="file-feedback text-error">File too large (max '+Math.round(100*connection.maxSubmissionSize()/1048576)/100+" Mb)</div>"),!0))}});var e={success:function(){console.log("Whoheee, we have permission to use the file system"),d.removeClass("ignore force-disabled").prop("disabled",!1).siblings(".file-feedback").remove().end().after('<div class="file-feedback text-info">File inputs are experimental. Use only for testing.')},error:function(){d.siblings(".file-feedback").remove(),d.after('<div class="file-feedback text-warning">No permission given to store local data (or an error occurred).</div>')}};d.each(function(){var a=$(this),b=a.attr("data-loaded-file-name");b&&a.after('<div class="file-loaded text-warning">This form was loaded with "'+b+'". To preserve this file, do not change this input.</div>')}).parent().addClass("with-media clearfix"),fileManager.init(f.getInstanceID(),e)}}},mediaLabelWidget:function(){this.repeat||$("fieldset:not(.jr-appearance-compact, .jr-appearance-quickcompact)>label, fieldset:not(.jr-appearance-compact, .jr-appearance-quickcompact)>legend").children("img,video,audio").parent().addClass("with-media clearfix")}},e.prototype.preloads={init:function(a){var b,c,d,e,g,h,j,k,l,m=this;i.find("#jr-preload-items input").each(function(){k=a.input.getProps($(this)),b=$(this).attr("data-preload").toLowerCase(),c=$(this).attr("data-preload-params").toLowerCase(),"undefined"!=typeof m[b]?(j=f.node(k.path,k.index),e=j.getVal()[0],g=m[b]({param:c,curVal:e,dataNode:j}),j.setVal(g,null,k.xmlType)):console.error('Preload "'+b+'"" not supported. May or may not be a big deal.')}),h=f.node("*>meta>*"),h.get().each(function(){if(b=null,d=$(this).prop("nodeName"),j=f.node("*>meta>"+d),e=j.getVal()[0],0===i.find('#jr-preload-items input[name$="/meta/'+d+'"][data-preload]').length)switch(d){case"instanceID":b="instance",l="string",c="";break;case"timeStart":b="timestamp",l="datetime",c="start";break;case"timeEnd":b="timestamp",l="datetime",c="end"}b&&j.setVal(m[b]({param:c,curVal:e,dataNode:j}),null,l)})},timestamp:function(a){var b;return"start"==a.param?a.curVal.length>0?a.curVal:f.evaluate("now()","string"):"end"==a.param?(i.on("beforesave",function(){b=f.evaluate("now()","string"),a.dataNode.setVal(b,null,"datetime")}),f.evaluate("now()","string")):"error - unknown timestamp parameter"},date:function(a){var b,c,d,e;return 0===a.curVal.length?(b=new Date(f.evaluate("today()","string")),c=b.getFullYear().toString().pad(4),d=(b.getMonth()+1).toString().pad(2),e=b.getDate().toString().pad(2),c+"-"+d+"-"+e):a.curVal},property:function(a){return 0===a.curVal.length?"no device properties in enketo":a.curVal},context:function(a){return 0===a.curVal.length?"application"==a.param?"enketo":a.param+" not supported in enketo":a.curVal},patient:function(a){return 0===a.curVal.length?"patient preload not supported in enketo":a.curVal},user:function(a){return 0===a.curVal.length?"user preload item not supported in enketo yet":a.curVal},uid:function(a){return 0===a.curVal.length?"no uid yet in enketo":a.curVal},browser:function(){},os:function(a){return 0===a.curVal.length?"not known":a.curVal},instance:function(a){return a.curVal.length>0?a.curVal:f.evaluate("concat('uuid:', uuid())","string")}},e.prototype.repeat={init:function(a){var b,c,d,e,g,h,j,k,l,m=this;this.formO=a,i.find("fieldset.jr-repeat").prepend('<span class="repeat-number"></span>'),i.find("fieldset.jr-repeat:not([data-repeat-fixed])").append('<button type="button" class="btn repeat"><i class="icon-plus"></i></button><button type="button" disabled class="btn remove"><i class="icon-minus"></i></button>'),i.on("click","button.repeat:enabled",function(){return m.clone($(this).parent("fieldset.jr-repeat")),!1}),i.on("click","button.remove:enabled",function(){return m.remove($(this).parent("fieldset.jr-repeat.clone")),!1}),h=function(a){for(j++,d=a.attr("data-repeat-count")||"",c=d.length>0?parseInt(f.node(d).getVal()[0],10):0,l=i.find('.jr-repeat[name="'+a.attr("name")+'"]').index(a),k=f.node(a.attr("name"),l).get(),e=k.siblings(k.prop("nodeName")+":not([template])").addBack().length,g=c>e?c:e,b=1;g>b;b++)m.clone(a.siblings().addBack().last(),!1);a.siblings(".jr-repeat").addBack().find(".jr-repeat").filter(function(){return $(this).parents(".jr-repeat").length===j}).each(function(){h($(this))})},i.find(".jr-repeat").filter(function(){return 0===$(this).parents(".jr-repeat").length}).each(function(){j=0,h($(this))})},clone:function(a,b){var c,d,e,g,h,j,k,l,m,n=this;if(m=b===!1?0:400,1!==a.length)return console.error("Nothing to clone"),!1;for(e=a.parent("fieldset.jr-group"),c=e.children("fieldset.jr-repeat:not(.clone)").eq(0),d=c.clone(!1),d.addClass("clone").find(".clone, .widget").remove(),d.find(".invalid-required, .invalid-constraint").find("input, select, textarea").each(function(){n.formO.setValid($(this))}),d.insertAfter(a).parent(".jr-group").numberRepeats(),d.clearInputs(""),n.formO.widgets.init(d),g=i.find('fieldset.jr-repeat[name="'+a.attr("name")+'"]').index(a),h=[],d.find('input[type="radio"]').each(function(){-1===$.inArray($(this).attr("data-name"),h)&&h.push($(this).attr("data-name"))}),console.debug("different radioNames in clone: "+h.join()),j=0;j<h.length;j++)l=(new Date).getTime().toString()+"_"+Math.floor(1e4*Math.random()+1),d.find('input[type="radio"][data-name="'+h[j]+'"]').attr("name",l);return this.toggleButtons(c.parent()),k=c.attr("name"),console.log("index of form node to clone: "+g),k.length>0&&g>=0&&f.cloneTemplate(k,g),i.trigger("changerepeat"),!0},remove:function(a){var b=600,c=this,d=a.attr("name"),e=i.find('fieldset.jr-repeat[name="'+d+'"]').index(a),g=a.parent("fieldset.jr-group");a.hide(b,function(){a.remove(),g.numberRepeats(),c.toggleButtons(g),i.trigger("changerepeat"),f.node(d,e).remove()})},toggleButtons:function(a){console.debug("toggling repeat buttons"),a="undefined"!=typeof a&&0!==a.length&&a?a:a=i,a.find("button.repeat, button.remove").prop("disabled",!0),a.find("fieldset.jr-repeat:last-child > button.repeat").prop("disabled",!1),a.find("button.remove:not(:eq(0))").prop("disabled",!1)}},e.prototype.setEventHandlers=function(){var a=this;$("form.jr").attr("onsubmit","return false;"),i.on("blur",'input:not([type="text"], [type="radio"], [type="checkbox"])',function(){"undefined"!=typeof $(this).prop("validity").badInput&&$(this).prop("validity").badInput&&$(this).val("")}),i.on("change.file validate","input:not(.ignore), select:not(.ignore), textarea:not(.ignore)",function(b){var c,d,e=a.input.getProps($(this));b.stopImmediatePropagation(),e.val.length>0&&"file"===e.inputType&&$(this)[0].files[0]&&$(this)[0].files[0].size>0&&(e.val=$(this)[0].files[0].name,$(this).attr("data-previous-file-name",e.val)),c="validate"===b.type?e.enabled&&"hidden"!==e.inputType?f.node(e.path,e.ind).validate(e.constraint,e.xmlType):!0:f.node(e.path,e.ind).setVal(e.val,e.constraint,e.xmlType),d=e.enabled&&"hidden"!==e.inputType&&e.required&&e.val.length<1?!1:!0,d===!1?(a.setValid($(this),"constraint"),"validate"===b.type&&a.setInvalid($(this),"required")):(a.setValid($(this),"required"),"undefined"!=typeof c&&c===!1?a.setInvalid($(this),"constraint"):null!==c&&a.setValid($(this),"constraint"))}),i.on("focus blur","[required]",function(b){var c=a.input.getProps($(this)),d=$(this).parents(".invalid-required, .invalid-constraint").length>0,e=$(this).next(".required-subtle"),f=$('<span class="required-subtle focus" style="color: transparent;">Required</span>');console.debug("event: ",b),"focusin"===b.type?0===e.length?(e=$(f),e.insertAfter(this),d||e.show(function(){$(this).removeAttr("style")})):d||e.addClass("focus"):"focusout"===b.type&&(c.val.length>0?e.remove():(e.removeClass("focus"),d||e.removeAttr("style")))}),i.on("dataupdate",function(b,c){a.calcUpdate(c),a.branch.update(c),a.outputUpdate(c),a.itemsetUpdate(c)}),i.on("change changerepeat",function(){a.editStatus.set(!0)}),i.on("changerepeat",function(){a.setAllVals()}),i.on("changelanguage",function(){a.outputUpdate(),a.setHints()})},e.prototype.setValid=function(a,b){var c=b?"invalid-"+b:"invalid-constraint invalid-required";this.input.getWrapNodes(a).removeClass(c)},e.prototype.setInvalid=function(a,b){b=b||"constraint",this.input.getWrapNodes(a).addClass("invalid-"+b).find(".required-subtle").attr("style","color: transparent;")},e.prototype.generateName=function(a){for(var b=[a.prop("nodeName")],c=a.parent();1==c.length&&"instance"!==c.prop("nodeName")&&"#document"!==c.prop("nodeName");)b.push(c.prop("nodeName")),c=c.parent();return"/"+b.reverse().join("/")},e.prototype.validateAll=function(){var a=this;return i.find("fieldset:disabled input, fieldset:disabled select, fieldset:disabled textarea, input:disabled, select:disabled, textarea:disabled").each(function(){a.setValid($(this))}),i.find("input, select, textarea").not(".ignore").trigger("validate"),this.isValid()},e.prototype.isValid=function(){return i.find(".invalid-required, .invalid-constraint").length>0?!1:!0},e.prototype.addPageBreaks=function(){}}var gui,printO;$(document).ready(function(){"use strict";helper.setSettings(),gui=new GUI,gui.init(),"undefined"==typeof console&&(console={log:function(){}}),"undefined"==typeof window.console.debug&&(console.debug=console.log),settings.debug||(window.console.log=function(){},window.console.debug=function(){}),settings.touch?(Modernizr.touch=!0,$("html").addClass("touch")):settings.touch===!1&&(Modernizr.touch=!1,$("html").removeClass("touch")),printO=new Print}),GUI.prototype.init=function(){"use strict";this.nav.setup(),this.pages.init(),this.setEventHandlers(),"function"==typeof this.setCustomEventHandlers&&this.setCustomEventHandlers(),$("footer").detach().appendTo("#container"),this.positionPageAndBar()},GUI.prototype.setup=function(){"use strict";$(window).trigger("resize")},GUI.prototype.setEventHandlers=function(){"use strict";var a=this;$(document).on("click","#feedback-bar .close",function(){return a.feedbackBar.hide(),!1}),$(document).on("click",".touch #feedback-bar",function(){a.feedbackBar.hide()}),$(document).on("click","#page .close",function(){return a.pages.close(),!1}),$("button.print").on("click",function(){printO.printForm()}),$(document).on("click",'a[href^="#"]:not([href="#"]):not(nav ul li a)',function(a){var b=$(this).attr("href");console.log("captured click to nav page, href="+b),"#"!==b&&(a.preventDefault(),$('nav li a[href="'+b+'"]').click())}),$('nav ul li a[href^="#"]').click(function(b){b.preventDefault();var c=$(this).attr("href").substr(1);a.pages.open(c),$(this).closest("li").addClass("active").siblings().removeClass("active")}),$(window).on("onlinestatuschange",function(b,c){a.updateStatus.connection(c)}),$(document).on("edit","form.jr",function(b,c){a.updateStatus.edit(c)}),$(document).on("browsersupport",function(b,c){a.updateStatus.support(c)}),$("#page, #feedback-bar").on("change",function(){a.positionPageAndBar()}),$(document).on("xpatherror",function(b,c){var d=settings.supportEmail;a.alert('A formula evaluation error occurred. Please contact <a href="mailto:'+d+"?subject=xpath errors for: "+location.href+"&body="+c+'" target="_blank" >'+d+"</a>"+' with this error:<ul class="error-list"><li>'+c+"</li></ul>","Formula Error")})},GUI.prototype.nav={setup:function(){"use strict";$("article.page").each(function(){var a,b,c,d="";b=$(this).attr("id"),a=$(this).attr("data-display-icon")?'<img src="/images/'+$(this).attr("data-display-icon")+'" alt="menu-icon" />':$(this).attr("data-display")?$(this).attr("data-display"):b,d=$(this).attr("data-title")?$(this).attr("data-title"):b,c=$(this).attr("data-ext-link")?$(this).attr("data-ext-link"):"#"+b,$('<li class=""><a href="'+c+'" title="'+d+'" >'+a+"</a></li>").appendTo($("nav.pull-right ul"))})},reset:function(){"use strict";$("nav ul li").removeClass("active")}},GUI.prototype.pages={init:function(){this.$pages=$("<pages></pages>"),$("article.page").detach().appendTo(this.$pages)},get:function(a){var b=this.$pages.find('article[id="'+a+'"]');return b=b.length>0?b:$('article[id="'+a+'"]')},isShowing:function(a){var b="undefined"!=typeof a?'[id="'+a+'"]':"";return $("#page article.page"+b).length>0},open:function(a){var b,c=($("header"),this);if(!this.isShowing(a)){if(b=this.get(a),1!==b.length)return console.error("page not found"),void 0;this.isShowing()&&this.close(),$("#page .content").prepend(b.show()).trigger("change"),$("#page").show(),$(".main").css("opacity","0.3"),$(window).on("resize.pageEvents",function(){$("#page").trigger("change")}),setTimeout(function(){$(window).on("click.pageEvents",function(a){return console.log($(a.target).prop("nodeName")),0===$(a.target).parents(".btn-toolbar, label, fieldset").length&&c.close(),!0})},1e3)}},close:function(){var a=$("#page .page").length>0?$("#page .page").detach():[];a.length>0&&(this.$pages.append(a),$("#page").trigger("change"),$("nav ul li").removeClass("active"),$(window).off(".pageEvents")),$(".main").css("opacity","1")}},GUI.prototype.feedbackBar={show:function(a,b){"use strict";var c;b=b?1e3*b:1e4,$("#feedback-bar p").eq(1).remove(),$("#feedback-bar p").html()!==a&&(c=$("<p></p>"),c.append(a),$("#feedback-bar").append(c)),$("#feedback-bar").show().trigger("change"),setTimeout(function(){"undefined"!=typeof c&&c.remove(),$("#feedback-bar").trigger("change")},b)},hide:function(){"use strict";$("#feedback-bar p").remove(),$("#feedback-bar").trigger("change")}},GUI.prototype.feedback=function(a,b,c,d){c=c||"Information",Modernizr.touch?d?this.confirm({msg:a,heading:c},d,b):this.alert(a,c,"info",b):this.feedbackBar.show(a,b)},GUI.prototype.alert=function(a,b,c,d){"use strict";var e,f,g=$("#dialog-alert");if(b=b||"Alert",c=c||"error",e="normal"===c?"":"alert alert-block alert-"+c,g.find(".modal-header h3").text(b),g.find(".modal-body p").removeClass().addClass(e).html(a).capitalizeStart(),g.modal({keyboard:!0,show:!0}),g.on("hidden",function(){g.find(".modal-header h3, .modal-body p").html(""),clearInterval(f)}),"number"==typeof d){var h=d.toString();g.find(".self-destruct-timer").text(h),f=setInterval(function(){h--,g.find(".self-destruct-timer").text(h)},1e3),setTimeout(function(){clearInterval(f),g.find(".close").click()},1e3*d)}},GUI.prototype.confirm=function(a,b,c){"use strict";var d,e,f,g,h,i;if("string"==typeof a?d=a:"string"==typeof a.msg&&(d=a.msg),d="undefined"!=typeof d?d:"Please confirm action",e="undefined"!=typeof a.heading?a.heading:"Are you sure?",f="undefined"!=typeof a.errorMsg?a.errorMsg:"",g="undefined"!=typeof a.dialog?a.dialog:"confirm",b="undefined"!=typeof b?b:{},b.posButton=b.posButton||"Confirm",b.negButton=b.negButton||"Cancel",b.posAction=b.posAction||function(){return!1},b.negAction=b.negAction||function(){return!1},b.beforeAction=b.beforeAction||function(){},h=$("#dialog-"+g),h.find(".modal-header h3").text(e),h.find(".modal-body .msg").html(d).capitalizeStart(),h.find(".modal-body .alert-error").html(f).show(),f||h.find(".modal-body .alert-error").hide(),h.modal({keyboard:!0,show:!0}),h.on("shown",function(){b.beforeAction.call()}),h.find("button.positive").on("click",function(){b.posAction.call(),h.modal("hide")}).text(b.posButton),h.find("button.negative").on("click",function(){b.negAction.call(),h.modal("hide")}).text(b.negButton),h.on("hide",function(){h.off("shown hidden hide"),h.find("button.positive, button.negative").off("click")}),h.on("hidden",function(){h.find(".modal-body .msg, .modal-body .alert-error, button").text("")}),"number"==typeof c){var j=c.toString();h.find(".self-destruct-timer").text(j),i=setInterval(function(){j--,h.find(".self-destruct-timer").text(j)},1e3),setTimeout(function(){clearInterval(i),h.find(".close").click()},1e3*c)}},GUI.prototype.confirmLogin=function(a,b){a=a||"<p>In order to submit your queued data, you need to login. If you want to do this now, you will be redirected, and loose unsaved information.</p><p>Would you like to login now or later?</p>",b=b||settings.serverURL,gui.confirm({msg:a,heading:"Login Required"},{posButton:"Log in now",negButton:"Later",posAction:function(){var a="?server="+encodeURIComponent(b)+"&return="+encodeURIComponent(location.href);a+=settings.formId?"&id="+settings.formId:"",a+=settings.touch?"&touch="+settings.touch:"",a+=settings.debug?"&debug="+settings.debug:"",location.href=location.protocol+"//"+location.host+"/authenticate"+a},negAction:function(){console.log("login cancelled")},beforeAction:function(){}})},GUI.prototype.showLoadErrors=function(a,b){var c='<ul class="error-list"><li>'+a.join("</li><li>")+"</li></ul",d="* "+a.join("* "),e=a.length>1?"s":"",f=settings.supportEmail;b=b||"",this.alert("<p>Error"+e+" occured during the loading of this form. "+b+"</p><br/><p>"+'Please contact <a href="mailto:'+f+"?subject=loading errors for: "+location.href+"&body="+d+'" target="_blank" >'+f+"</a>"+" with the link to this page and the error message"+e+" below:</p>"+c,"Loading Error"+e)},GUI.prototype.updateStatus={connection:function(){"use strict"},edit:function(a){"use strict";a?$("header #status-editing").removeClass().addClass("ui-icon ui-icon-pencil").attr("title","Form is being edited."):$("header #status-editing").removeClass().attr("title","")},support:function(){},offlineLaunch:function(a){var b=a?"Offline Launch: Yes":"Offline Launch: No";$(".drawer #status-offline-launch").text(b)}},GUI.prototype.fillHeight=function(a){var b=$(window).height(),c=$("header").outerHeight(!0),d=a.outerHeight()-a.height();return b-c-d},GUI.prototype.positionPageAndBar=function(){"use strict";console.log("positionPageAndBar called");var a,b,c=$("header"),d=c.outerHeight()||0,e=$("#feedback-bar"),f=e.find("p").length>0?!0:!1,g=e.outerHeight(),h=$("#page"),i=this.pages.isShowing(),j=h.outerHeight();return h.css({position:c.css("position")}),c.length>0&&"fixed"!==c.css("position")?(f||e.hide(),i||h.hide(),!1):(a=f?d:0-g,b=i?f?a+g:d:0-j,e.css("top",a),h.css("top",b),void 0)},GUI.prototype.setSettings=function(a){"use strict";var b,c=this;console.log("gui updateSettings() started"),$.each(a,function(a,d){b=d?c.pages.get("settings").find('input[name="'+a+'"][value="'+d+'"]'):c.pages.get("settings").find('input[name="'+a+'"]'),d=d?!0:!1,b.length>0&&b.attr("checked",d).trigger("change")})},GUI.prototype.parseFormlist=function(a,b,c){var d,e="";if(console.log("list: ",a),$.isEmptyObject(a))b.addClass("empty"),c||(e='<p class="alert alert-error">Error occurred during creation of form list or no forms found</p>');else{for(d=0;d<a.length;d++)e+='<li><a class="btn btn-block btn-info" id="'+a[d].form_id+'" title="'+a[d].title+'" '+'href="'+a[d].url+'" data-server="'+a[d].server_url+'" >'+a[d].name+"</a></li>";b.removeClass("empty")}b.find("ul").empty().append(e)},Print.prototype.setDpi=function(){var a={},b=document.body.appendChild(document.createElement("DIV"));b.style.width="1in",b.style.padding="0",a.v=b.offsetWidth,b.parentNode.removeChild(b),this.dpi=a.v},Print.prototype.setStyleSheet=function(){this.styleSheet=this.getStyleSheet(),this.$styleSheetLink=$('link[media="print"]:eq(0)')},Print.prototype.getStyleSheet=function(){for(var a=0;a<document.styleSheets.length;a++)if("print"===document.styleSheets[a].media.mediaText)return document.styleSheets[a];return null},Print.prototype.styleToAll=function(){this.styleSheet||this.setStyleSheet(),this.styleSheet.media.mediaText="all",this.$styleSheetLink.attr("media","all")},Print.prototype.styleReset=function(){this.styleSheet.media.mediaText="print",this.$styleSheetLink.attr("media","print")},Print.prototype.printForm=function(){this.removePageBreaks(),this.removePossiblePageBreaks(),this.styleToAll(),this.addPageBreaks(),this.styleReset(),window.print()},Print.prototype.removePageBreaks=function(){$(".page-break").remove()},Print.prototype.removePossiblePageBreaks=function(){$(".possible-break").remove()},Print.prototype.addPossiblePageBreaks=function(){var a=$("<hr>",{"class":"possible-break"});this.removePossiblePageBreaks(),$("form.jr").before(a.clone()).after(a.clone()).find("fieldset>legend, label:not(.geo)>input:not(input:radio, input:checkbox), label>select, label>textarea, .trigger>*, h4>*, h3>*, .jr-appearance-field-list>*").parent().each(function(){var b,c;return b=$(this),c=b.prev().get(0),c&&("H3"===c.nodeName||"H4"===c.nodeName)||$(c).hasClass("repeat-number")||b.parents("#jr-calculated-items, #jr-preload-items").length>0||b.parents(".jr-appearance-field-list").length>0?null:b.before(a.clone())}),$(".possible-break").each(function(){return $(this).prev().hasClass("possible-break")?$(this).remove():void 0})},Print.prototype.addPageBreaks=function(){var a,b,c,d,e,f,g,h,i,j,k,l,m=9.5,n=this.dpi*m,o="<hr class='page-break' />",p=function(){function a(a,b){if(this.begin=$(a),this.begin_top=this.begin.offset().top,this.end=$(b),this.end_top=this.end.offset().top,this.h=this.end_top-this.begin_top,this.h<0)throw console.debug("begin (top: "+this.begin_top+")",a),console.debug("end (top: "+this.end_top+")",b),new Error("A question group has an invalid height.")}return a.prototype.break_before=function(){var a,b,c,d;return c=this.begin.prev().get(0),d=c?["after",c]:["before",this.begin.parent().get(0)],a=d[0],b=d[1],$(b)[a](o)},a}();for(this.removePageBreaks(),this.addPossiblePageBreaks(),f=$(".possible-break"),h=[],a=1;a<f.length;a++)h.push(new p(f[a-1],f[a]));for(d=0,c=[],e=[],i=0,k=h.length;k>i;i++)g=h[i],d+g.h>n?(e.push(c),c=[g],d=g.h):(c.push(g),d+=g.h);for(e.push(c),console.debug("pages: ",e),j=1,l=e.length;l>j;j++)b=e[j],b.length>0&&b[0].break_before();return $(".possible-break").remove()},String.prototype.pad=function(a){for(var b=this;b.length<a;)b="0"+b;return b};var profilerRecords=[],xpathEvalNum=0,xpathEvalTime=0,xpathEvalTimePure=0,helper=new Helper;window.onload=function(){setTimeout(function(){var a,b,c,d,e={};if(window.performance){b=window.performance.timing,c=b.loadEventEnd-b.responseEnd,"undefined"!=typeof settings&&settings.debug&&(d=window.localStorage.getItem("__loadLog"),a=d?JSON.parse(d):[],a.push(c),a.length>10&&a.shift(),window.localStorage.setItem("__loadLog",JSON.stringify(a))),profilerRecords.push("total loading time: "+c+" milliseconds");for(var f in window.performance.timing)e[f]=window.performance.timing[f];window.opener&&window.performance&&window.postMessage&&window.opener.postMessage(JSON.stringify(e),"*"),$(profilerRecords).each(function(a,b){console.log(b)})}},0)},function(a){"use strict";a.fn.getXPath=function(a){for(var b=this.first(),c=b.prop("nodeName"),d=[c],e=b.parent(),f=e.prop("nodeName");1==e.length&&f!==a&&"#document"!==f;)d.push(f),e=e.parent(),f=e.prop("nodeName");return"/"+d.reverse().join("/")},a.fn.toLargestWidth=function(b){var c=0;return b=b||0,this.each(function(){a(this).width()>c&&(c=a(this).width())}).each(function(){a(this).width(c+b)})},a.fn.toSmallestWidth=function(){var b=2e3;return this.each(function(){a(this).width()<b&&(b=a(this).width())}).each(function(){a(this).width(b)})},a.fn.reverse=[].reverse,a.fn.alphanumeric=function(b){return b=a.extend({ichars:"!@#$%^&*()+=[]\\';,/{}|\":<>?~`.- ",nchars:"",allow:""},b),this.each(function(){b.nocaps&&(b.nchars+="ABCDEFGHIJKLMNOPQRSTUVWXYZ"),b.allcaps&&(b.nchars+="abcdefghijklmnopqrstuvwxyz");
for(var c=b.allow.split(""),d=0;d<c.length;d++)-1!=b.ichars.indexOf(c[d])&&(c[d]="\\"+c[d]);b.allow=c.join("|");var e=new RegExp(b.allow,"gi"),f=b.ichars+b.nchars;f=f.replace(e,""),a(this).keypress(function(a){var b;b=a.charCode?String.fromCharCode(a.charCode):String.fromCharCode(a.which),-1!=f.indexOf(b)&&a.preventDefault(),a.ctrlKey&&"v"==b&&a.preventDefault()}),a(this).bind("contextmenu",function(){return!1})})},a.fn.numeric=function(b){var c="abcdefghijklmnopqrstuvwxyz";return c+=c.toUpperCase(),b=a.extend({nchars:c},b),this.each(function(){a(this).alphanumeric(b)})},a.fn.alpha=function(b){var c="1234567890";return b=a.extend({nchars:c},b),this.each(function(){a(this).alphanumeric(b)})},a.fn.btnBusyState=function(b){var c,d;return this.each(function(){c=a(this),d=c.data("btnContent"),console.log("busy ",b),console.log("btnContent",d),b&&!d?(d=c.html(),c.data("btnContent",d),c.empty().append("<progress></progress>").attr("disabled",!0)):!b&&d&&(c.data("btnContent",null),c.empty().append(d).removeAttr("disabled"))})},a.fn.capitalizeStart=function(a){a||(a=1);var b=this.contents().filter(function(){return 3==this.nodeType}).first(),c=b.text(),d=c.split(" ",a).join(" ");b.length&&(b[0].nodeValue=c.slice(d.length),b.before('<span class="capitalize">'+d+"</span>"))}}(jQuery),Date.prototype.toISOLocalString=function(){var a={},b=function(a){return 10>a?"0"+a:a};return"Invalid Date"==this.toString()?this.toString():(a.minstotal=this.getTimezoneOffset(),a.direction=a.minstotal<0?"+":"-",a.hrspart=b(Math.abs(Math.floor(a.minstotal/60))),a.minspart=b(Math.abs(Math.floor(a.minstotal%60))),new Date(this.getTime()-1e3*60*a.minstotal).toISOString().replace("Z",a.direction+a.hrspart+":"+a.minspart))},function(a){"use strict";a.fn.numberRepeats=function(){return this.each(function(){a(this).find("fieldset.jr-repeat").each(function(){var b,c,d;0===a(this).prev("fieldset.jr-repeat").length&&(b=a(this).siblings("fieldset.jr-repeat"),c=b.length+1,c>1?(a(this).find("span.repeat-number").text("1"),d=2,b.each(function(){a(this).find("span.repeat-number").text(d),d++})):a(this).find("span.repeat-number").empty())})})},a.fn.clearInputs=function(b){return b=b||"edit",this.each(function(){a(this).find(".file-preview").remove(),a(this).find("input, select, textarea").each(function(){var c=a(this).attr("type");switch("SELECT"===a(this).prop("nodeName").toUpperCase()&&(c="select"),"TEXTAREA"===a(this).prop("nodeName").toUpperCase()&&(c="textarea"),c){case"date":case"datetime":case"time":case"number":case"search":case"color":case"range":case"url":case"email":case"password":case"text":case"file":a(this).removeAttr("data-previous-file-name data-loaded-file-name");case"hidden":case"textarea":""!==a(this).val()&&a(this).val("").trigger(b);break;case"radio":case"checkbox":a(this).prop("checked")&&(a(this).prop("checked",!1),a(this).trigger(b));break;case"select":a(this)[0].selectedIndex>=0&&(a(this)[0].selectedIndex=-1,a(this).trigger(b));break;default:console.error("Unrecognized input type found when trying to reset: "+c),console.error(a(this))}})})},a.fn.xfind=function(a){var b,c,d;if(a=a.replace(/\/\//g," "),a=a.replace(/^\//,""),a=a.replace(/\/\.$/,""),a=a.replace(/\//g,">"),a=a.replace(/\[([^@].*?)\]/g,function(a,b){return":has("+b+")"}),a.indexOf(">..")>=0){for(b=a.split(/>\.\.>?/g),c=jQuery(b[0],this),d=1;d<b.length;d++)c=c.parent(b[d]);return c.get()}return a=a.replace(/\./gi,"\\."),this.find(a)},a.fn.markdownToHtml=function(){return this.each(function(){var b,c=a("<div/>");a(this).children().each(function(b){var d="$$$"+b;a(this).clone().markdownToHtml().appendTo(c),a(this).replaceWith(d)}),b=a(this).html(),b=b.replace(/__([^\s][^_]*[^\s])__/gm,"<strong>$1</strong>"),b=b.replace(/\*\*([^\s][^\*]*[^\s])\*\*/gm,"<strong>$1</strong>"),b=b.replace(/_([^\s][^_]*[^\s])_/gm,"<em>$1</em>"),b=b.replace(/\*([^\s][^\*]*[^\s])\*/gm,"<em>$1</em>"),b=b.replace(/\[(.*)\]\(((https?:\/\/)(([\da-z\.\-]+)\.([a-z\.]{2,6})|(([0-9]{1,3}\.){3}[0-9]{1,3}))([\/\w \.\-]*)*\/?[\/\w \.\-\=\&\?]*)\)/gm,'<a href="$2">$1</a>'),b=b.replace(/\n/gm,"<br />"),c.children().each(function(c){var d=new RegExp("\\$\\$\\$"+c);b=b.replace(d,a(this)[0].outerHTML)}),a(this).text("").append(b)})}}(jQuery),function(a){"use strict";var b=function(b,c,d){d&&(d.stopPropagation(),d.preventDefault()),this.$element=a(b),this.$newElement=null,this.selectClass=c.btnStyle||"",this.noneSelectedText=c.noneSelectedText||"none selected",this.lengthmax=c.maxlength||20,this.multiple="undefined"!=typeof this.$element.attr("multiple")&&this.$element.attr("multiple")!==!1,this.init()};b.prototype={constructor:b,init:function(){var a=this.getTemplate();this.$element.css("display","none"),a=this.createLi(a),this.$element.after(a),this.$newElement=this.$element.next(".bootstrap-select"),this.$newElement.find("> a").addClass(this.selectClass),this.clickListener()},getTemplate:function(){var a="<div class='btn-group bootstrap-select widget'><a class='btn dropdown-toggle clearfix' data-toggle='dropdown' href='#''><span class='filter-option pull-left'>__SELECTED_OPTIONS</span><span class='caret pull-right'></span></a><ul class='dropdown-menu' role='menu'>__ADD_LI</ul></div>";return a},createLi:function(b){var c,d,e=[],f="",g=this.multiple?"type='checkbox'":"type='radio' style='display: none;' name='"+1e5*Math.random()+"'",h=this;if(this.$element.find("option").each(function(){e.push({label:a(this).text(),selected:a(this).is(":selected"),value:a(this).attr("value")})}),e.length>0){b=b.replace("__SELECTED_OPTIONS",this.createSelectedStr());for(var i=0;i<e.length;i++)e[i].value&&(c=e[i].selected?" checked='checked'":"",d=e[i].selected&&!h.multiple?"class='active'":"",f+="<li "+d+"><a tabindex='-1' href='#'><label class='checkbox inline'>"+"<input class='ignore' "+g+c+"value='"+e[i].value+"' />"+e[i].label+"</label></a></li>")}return b=b.replace("__ADD_LI",f)},createSelectedStr:function(b){var c,d=[];return b=b||this.$element,b.find("option:selected").each(function(){a(this).attr("value").length>0&&d.push(a(this).text())}),0===d.length?this.noneSelectedText:(c=d.join(", "),c.length>this.lengthmax?d.length+" selected":c)},clickListener:function(){var b=this;this.$newElement.find("li").on("click",function(c){c.preventDefault();var d=a(this),e=d.find("input"),f=d.parents(".bootstrap-select"),g=f.prev("select"),h=g.find('option[value="'+e.val()+'"]'),i=h.is(":selected");b.multiple||(f.find("li").removeClass("active"),h.siblings("option").prop("selected",!1),f.find("input").prop("checked",!1)),i?(d.removeClass("active"),e.prop("checked",!1),h.prop("selected",!1)):(b.multiple||d.addClass("active"),e.prop("checked",!0),h.prop("selected",!0)),f.find(".filter-option").html(b.createSelectedStr(g)),g.trigger("change")})},focusListener:function(){var a=this;a.$newElement.find(".dropdown-toggle").hover(function(){return console.debug("focus..."),a.$element.trigger("focus"),!0},function(){return console.debug("blur..."),a.$element.trigger("blur"),!0})},update:function(){this.$newElement.remove(),this.init()}},a.fn.selectpicker=function(c,d){return this.each(function(){var e=a(this),f=e.data("selectpicker"),g="object"==typeof c&&c;f||e.data("selectpicker",f=new b(this,g,d)),"string"==typeof c&&f[c]()})},a.fn.selectpicker.Constructor=b}(window.jQuery),function(a){"use strict";var b=function(b,c){var d='<button name="geodetect" type="button" class="btn" title="detect current location" data-placement="top"><i class="icon-crosshairs"></i></button>',e='<div class="input-append"><input class="geo ignore" name="search" type="text" placeholder="search for place or address" disabled="disabled"/><button type="button" class="btn add-on"><i class="icon-search"></i></div>',f='<div class="map-canvas-wrapper"><div class="map-canvas"></div></div>';this.$inputOrigin=a(b),this.$form=this.$inputOrigin.closest("form"),this.$widget=a('<div class="geopoint widget"><div class="search-bar no-search-input no-map"></div><div class="geo-inputs"><label class="geo">latitude (x.y &deg;)<input class="ignore" name="lat" type="number" step="0.0001" /></label><label class="geo">longitude (x.y &deg;)<input class="ignore" name="long" type="number" step="0.0001" /></label><label class="geo"><input class="ignore" name="alt" type="number" step="0.1" />altitude (m)</label><label class="geo"><input class="ignore" name="acc" type="number" step="0.1" />accuracy (m)</label></div></div>'),navigator.geolocation&&(this.$widget.find(".search-bar").append(d),this.$detect=this.$widget.find('button[name="geodetect"]')),c.touch!==!0&&(this.$widget.find(".search-bar").removeClass("no-search-input").append(e),this.$search=this.$widget.find('[name="search"]')),(c.touch!==!0||c.touch===!0&&this.$inputOrigin.parents(".jr-appearance-maps").length>0)&&(this.$widget.find(".search-bar").removeClass("no-map").after(f),this.$map=this.$widget.find(".map-canvas")),this.$lat=this.$widget.find('[name="lat"]'),this.$lng=this.$widget.find('[name="long"]'),this.$alt=this.$widget.find('[name="alt"]'),this.$acc=this.$widget.find('[name="acc"]'),this.$inputOrigin.hide().after(this.$widget),this.updateMapFn="updateDynamicMap",this.touch=c.touch||!1,this.init()};b.prototype={constructor:b,init:function(){var b=this,c=this.$inputOrigin.val().split(" ");this.$inputOrigin.parent().addClass("clearfix"),this.$widget.find('input:not([name="search"])').on("change change.bymap change.bysearch",function(a){var c=""!==b.$lat.val()?b.$lat.val():0,d=""!==b.$lng.val()?b.$lng.val():0,e=""!==b.$alt.val()?b.$alt.val():0,f=b.$acc.val(),g=0===c&&0===d?"":c+" "+d+" "+e+" "+f;a.stopImmediatePropagation(),b.$inputOrigin.val(g).trigger("change"),"bymap"!==a.namespace&&"bysearch"!==a.namespace&&b.updateMap(c,d),"bysearch"!==a.namespace&&this.$search&&b.$search.val("")}),this.$widget.on("focus blur","input",function(a){b.$inputOrigin.trigger(a.type)}),c[3]&&this.$acc.val(c[3]),c[2]&&this.$alt.val(c[2]),c[1]&&this.$lng.val(c[1]),c[0].length>0&&this.$lat.val(c[0]).trigger("change"),this.$detect&&this.enableDetection(),this.touch?this.$map&&(this.updateMapFn="updateStaticMap",this.updateMap(0,0,1),a(window).on("resize",function(){var c=a(window).data("resizecount")||0;c++,a(window).data("resizecount",c),window.setTimeout(function(){c==a(window).data("resizecount")&&(a(window).data("resizecount",0),console.debug("resizing stopped"),b.updateMap())},500)})):b.dynamicMapAvailable()?(b.updateMap(0,0,1),b.$search&&b.enableSearch()):this.$form.on("googlemapsscriptloaded",function(){b.dynamicMapAvailable()&&(b.updateMap(0,0,1),b.$search&&b.enableSearch())})},enableDetection:function(){var a=this;this.$detect.click(function(b){return b.preventDefault(),navigator.geolocation.getCurrentPosition(function(b){a.updateMap(b.coords.latitude,b.coords.longitude),a.updateInputs(b.coords.latitude,b.coords.longitude,b.coords.altitude,b.coords.accuracy)}),!1})},enableSearch:function(){var b=new google.maps.Geocoder,c=this;this.$search.prop("disabled",!1),this.$search.on("change",function(d){d.stopImmediatePropagation();var e=a(this).val();return"undefined"!=typeof b&&b.geocode({address:e,bounds:c.map.getBounds()},function(a,b){if(b==google.maps.GeocoderStatus.OK){c.$search.attr("placeholder","search");var d=a[0].geometry.location;c.updateMap(d.lat(),d.lng()),c.updateInputs(d.lat(),d.lng(),null,null,"change.bysearch")}else c.$search.val(""),c.$search.attr("placeholder",e+" not found, try something else.")}),!1})},dynamicMapAvailable:function(){return this.$map&&"undefined"!=typeof google&&"undefined"!=typeof google.maps},updateMap:function(a,b,c){return this.$map?(a=a||Number(this.$lat.val()),b=b||Number(this.$lng.val()),c=c||15,0===a&&0===b&&(c=1),this[this.updateMapFn](a,b,c)):void 0},updateStaticMap:function(a,b,c){var d,e=this.$map.width(),f=this.$map.height(),g=settings.mapsStaticAPIKey||"";d="center="+a+","+b+"&size="+e+"x"+f+"&zoom="+c+"&sensor=false&key="+g,this.$map.empty().append('<img src="http://maps.googleapis.com/maps/api/staticmap?'+d+'"/>')},updateDynamicMap:function(a,b,c){var d=(this.$map,this);if(this.dynamicMapAvailable()&&"undefined"!=typeof google.maps.LatLng){var e={zoom:c,center:new google.maps.LatLng(a,b),mapTypeId:google.maps.MapTypeId.ROADMAP,streetViewControl:!1};this.map=new google.maps.Map(this.$map[0],e),this.placeMarker(),google.maps.event.addListener(this.map,"click",function(a){d.updateInputs(a.latLng.lat(),a.latLng.lng(),"","","change.bymap"),d.placeMarker(a.latLng)})}},placeMarker:function(a){var b;a=a||this.map.getCenter(),"undefined"!=typeof this.marker&&this.marker.setMap(null),this.marker=new google.maps.Marker({position:a,map:this.map,draggable:!0}),b=this,this.touch||(google.maps.event.addListener(this.marker,"dragend",function(){b.updateInputs(b.marker.getPosition().lat(),b.marker.getPosition().lng(),"","","change.bymap"),b.centralizeWithDelay()}),this.centralizeWithDelay(5e3)),this.centralizeWithDelay(0)},centralizeWithDelay:function(a){var b=this;window.setTimeout(function(){b.map.panTo(b.marker.getPosition())},a)},updateInputs:function(a,b,c,d,e){c=c||"",d=d||"",e=e||"change",this.$lat.val(Math.round(1e4*a)/1e4),this.$lng.val(Math.round(1e4*b)/1e4),this.$alt.val(Math.round(10*c)/10),this.$acc.val(Math.round(10*d)/10).trigger(e)},loadMapsScript:function(){}},a.fn.geopointWidget=function(c){var d=!1;return this.each(function(){var e=a(this),f=a(this).data("geopointwidget"),g="object"==typeof c&&c;d||"undefined"==typeof connection||"undefined"!=typeof google&&"undefined"!=typeof google.maps||c.touch||(d=!0,console.debug("loading maps script asynchronously"),connection.loadGoogleMaps(function(){a("form.jr").trigger("googlemapsscriptloaded")})),f||e.data("geopointwidget",f=new b(this,g)),"string"==typeof c&&f[c]()})},a.fn.geopointWidget.Constructor=b}(window.jQuery),function(a){"use strict";var b=function(b,c,d){d&&(d.stopPropagation(),d.preventDefault()),this.$fileInput=a(b),this.nameAttr=this.$fileInput.attr("name"),this.$fileNameInput=null,this.init()};b.prototype={constructor:b,init:function(){this.$fileInput.addClass("ignore"),this.$fileNameInput=a('<input type="hidden" />').attr("name",this.nameAttr).after(this.$fileInput),this.changeListener()},changeListener:function(){this.$fileInput.on("change",function(a){a.stopImmediatePropagation()})},getPersistentName:function(){}},a.fn.offlineFilepicker=function(c,d){return this.each(function(){var e=a(this),f=e.data("offlinefilepicker"),g="object"==typeof c&&c;f||e.data("offlinefilepicker",f=new b(this,g,d)),"string"==typeof c&&f[c]()})},a.fn.offlineFilepicker.Constructor=b}(window.jQuery);